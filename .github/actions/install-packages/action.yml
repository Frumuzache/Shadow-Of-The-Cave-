name: 'Install packages'
description: 'Install required packages for building the project'

runs:
  using: "composite"
  steps:
    # -------------------------
    # ðŸ§ Linux Dependencies (SFML 3 via vcpkg)
    # -------------------------
    - name: Define vcpkg env vars (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        echo "VCPKG_ROOT=${GITHUB_WORKSPACE}/vcpkg" >> "$GITHUB_ENV"
        echo "VCPKG_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake" >> "$GITHUB_ENV"
        echo "VCPKG_DEFAULT_BINARY_CACHE=${GITHUB_WORKSPACE}/.vcpkg-bincache" >> "$GITHUB_ENV"

    - name: Ensure vcpkg binary cache dir (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        mkdir -p "${GITHUB_WORKSPACE}/.vcpkg-bincache"

    - name: Cache vcpkg + binary cache (Linux)
      if: runner.os == 'Linux'
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-${{ runner.os }}-x64-linux-sfml3

    - name: Bootstrap vcpkg (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        if [[ ! -d "${VCPKG_ROOT}" ]]; then
          git clone https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
          "${VCPKG_ROOT}/bootstrap-vcpkg.sh" -disableMetrics
        fi

    - name: Install SFML 3 (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-linux

    - name: Install Valgrind (Linux valgrind job only)
      if: runner.os == 'Linux' && matrix.runs_valgrind == true
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends valgrind

    # -------------------------
    # ðŸ macOS Dependencies (Homebrew)
    # -------------------------
    - name: Install macOS Dependencies
      if: runner.os == 'macOS'
      shell: bash
      run: |
        set -eux
        brew update
        # Homebrew's 'sfml' formula may lag; keep as-is if your project fetches SFML 3 via CMake,
        # otherwise consider switching macOS to vcpkg like Linux/Windows MSVC.
        brew install sfml ninja

    # -------------------------
    # ðŸªŸ Windows Dependencies
    # -------------------------
    - name: Install Ninja (Windows)
      if: runner.os == 'Windows'
      shell: bash
      run: |
        choco install ninja -y

    # ----- Windows + MSVC (use vcpkg + SFML 3) -----
    - name: Define vcpkg env vars (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      shell: bash
      run: |
        set -eux
        echo "VCPKG_ROOT=${GITHUB_WORKSPACE}/vcpkg" >> "$GITHUB_ENV"
        echo "VCPKG_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake" >> "$GITHUB_ENV"
        echo "VCPKG_DEFAULT_BINARY_CACHE=${GITHUB_WORKSPACE}/.vcpkg-bincache" >> "$GITHUB_ENV"

    - name: Ensure vcpkg binary cache dir (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      shell: bash
      run: |
        set -eux
        mkdir -p "${GITHUB_WORKSPACE}/.vcpkg-bincache"

    - name: Cache vcpkg + binary cache (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-${{ runner.os }}-x64-windows-msvc-sfml3

    - name: Bootstrap vcpkg (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      shell: bash
      run: |
        set -eux
        if [[ ! -d "${VCPKG_ROOT}" ]]; then
          git clone https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
          "${VCPKG_ROOT}/bootstrap-vcpkg.bat" -disableMetrics
        fi

    - name: Install SFML 3 (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      shell: bash
      run: |
        set -eux
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-windows

    # ----- Windows + MinGW (NO vcpkg; avoid leaking toolchain file) -----
    # We intentionally do NOT set VCPKG_TOOLCHAIN_FILE for MinGW jobs.
    # Your CMake should either fetch SFML 3, or you provide prebuilt libs for MinGW.
