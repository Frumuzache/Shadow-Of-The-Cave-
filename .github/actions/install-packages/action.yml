name: 'Install packages'
description: 'Install required packages for building the project (SFML 3 via vcpkg on all OSes)'

runs:
  using: "composite"
  steps:
    # --------------------------------
    # Common: set up paths & caching
    # --------------------------------
    - name: Define vcpkg env vars
      shell: bash
      run: |
        set -eux
        # Where vcpkg will live in the workspace
        echo "VCPKG_ROOT=${GITHUB_WORKSPACE}/vcpkg" >> "$GITHUB_ENV"
        # Toolchain file used by CMake
        echo "VCPKG_TOOLCHAIN_FILE=${GITHUB_WORKSPACE}/vcpkg/scripts/buildsystems/vcpkg.cmake" >> "$GITHUB_ENV"
        # Binary cache to speed up subsequent runs
        echo "VCPKG_DEFAULT_BINARY_CACHE=${GITHUB_WORKSPACE}/.vcpkg-bincache" >> "$GITHUB_ENV"

    - name: Cache vcpkg + binary cache
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.VCPKG_ROOT }}
          ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
        key: vcpkg-${{ runner.os }}-${{ matrix.cxx || 'default' }}-sfml3

    # --------------------------------
    # Linux
    # --------------------------------
    - name: Install Linux build tools (no SFML from apt!)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        sudo apt-get update
        # Basic build deps and Ninja (keep SFML OUT of apt to avoid SFML 2)
        sudo apt-get install -y --no-install-recommends build-essential ninja-build git curl zip unzip pkg-config
        # Optional: for valgrind matrix
        if [ "${{ matrix.runs_valgrind || '' }}" = "true" ]; then
          sudo apt-get install -y --no-install-recommends valgrind
        fi

    # --------------------------------
    # macOS
    # --------------------------------
    - name: Install macOS build tools
      if: runner.os == 'macOS'
      shell: bash
      run: |
        set -eux
        brew update
        brew install ninja git

    # --------------------------------
    # Windows
    # --------------------------------
    - name: Install Windows build tools
      if: runner.os == 'Windows'
      shell: bash
      run: |
        choco install ninja -y

    # --------------------------------
    # vcpkg bootstrap (all OSes)
    # --------------------------------
    - name: Bootstrap vcpkg
      shell: bash
      run: |
        set -eux
        if [ ! -d "${VCPKG_ROOT}" ]; then
          git clone https://github.com/microsoft/vcpkg.git "${VCPKG_ROOT}"
        fi
        pushd "${VCPKG_ROOT}"
        git pull --ff-only || true
        if [ "${{ runner.os }}" = "Windows" ]; then
          ./bootstrap-vcpkg.bat
        else
          ./bootstrap-vcpkg.sh
        fi
        popd

    # --------------------------------
    # Install SFML 3 via vcpkg (triplet per OS)
    # --------------------------------
    - name: Install SFML 3 (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: |
        set -eux
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-linux

    - name: Install SFML 3 (macOS)
      if: runner.os == 'macOS'
      shell: bash
      run: |
        set -eux
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-osx

    - name: Install SFML 3 (Windows MSVC)
      if: runner.os == 'Windows' && matrix.cxx == 'cl'
      shell: bash
      run: |
        set -eux
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-windows

    - name: Install SFML 3 (Windows MinGW)
      if: runner.os == 'Windows' && matrix.cxx != 'cl'
      shell: bash
      run: |
        set -eux
        # MinGW triplet (static runtime by default). Adjust to x64-mingw-dynamic if you need DLLs.
        "${VCPKG_ROOT}/vcpkg" install sfml:x64-mingw-static
