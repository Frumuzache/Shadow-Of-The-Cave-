name: CMake + SFML3

on:
  push:
    branches: ['**']
    tags: ['**']
  # pull_request:
    # branches: ['**']
  workflow_dispatch:
    inputs:
      build_type:
        description: CMake build type
        required: false
        default: Release
        type: choice
        options: [Debug, Release, RelWithDebInfo, MinSizeRel]

jobs:
  build:
    name: ${{ matrix.os }} • ${{ env.BUILD_TYPE }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    env:
      # Build type comes from workflow_dispatch or defaults to Release
      BUILD_TYPE: ${{ github.event.inputs.build_type || 'Release' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Ensure we get SFML 3.x — create a vcpkg manifest (if your repo already
      # has vcpkg.json, you can delete this step).
      - name: Write vcpkg.json (SFML 3)
        run: |
          cat > vcpkg.json <<'JSON'
          {
            "name": "your-project",
            "version": "0.1.0",
            "dependencies": [
              { "name": "sfml", "version>=": "3.0.0" }
            ]
          }
          JSON
        shell: bash

      # Set up vcpkg and install dependencies from vcpkg.json
      - name: Setup vcpkg
        uses: lukka/run-vcpkg@v11
        with:
          vcpkgJsonGlob: 'vcpkg.json'
          runVcpkgInstall: true
          # Cache key is auto-derived from lockfile; keep default settings.

      # Helpful tools per-OS (optional)
      - name: Install Ninja (Ubuntu)
        if: startsWith(matrix.os, 'ubuntu')
        run: sudo apt-get update && sudo apt-get install -y ninja-build

      - name: Configure (CMake)
        run: >
          cmake -S . -B build
          -G Ninja
          -DCMAKE_BUILD_TYPE=${{ env.BUILD_TYPE }}
          -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_ROOT }}/scripts/buildsystems/vcpkg.cmake

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_TYPE }} -- -v

      # If you have tests, enable and keep these:
      # - name: CTest
      #   working-directory: build
      #   run: ctest --output-on-failure -C ${{ env.BUILD_TYPE }}

      # Publish build output as artifact (adjust paths as needed)
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-${{ matrix.os }}-${{ env.BUILD_TYPE }}
          path: |
            build/**
